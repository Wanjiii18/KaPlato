<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Manage Karenderia Locations</ion-title>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin-dashboard"></ion-back-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="location-management-container">
    
    <!-- Pending Applications -->
    <div class="section">
      <h2>
        <ion-icon name="time-outline"></ion-icon>
        Pending Location Setup
      </h2>
      <p>Karenderias that need their map location set</p>
      
      <div *ngIf="pendingKarenderias.length === 0" class="empty-state">
        <ion-icon name="checkmark-circle-outline"></ion-icon>
        <p>All approved karenderias have their locations set!</p>
      </div>
      
      <ion-card *ngFor="let karenderia of pendingKarenderias" class="karenderia-card">
        <ion-card-header>
          <ion-card-title>{{karenderia.business_name}}</ion-card-title>
          <ion-card-subtitle>{{karenderia.owner_name}} • {{karenderia.status}}</ion-card-subtitle>
        </ion-card-header>
        
        <ion-card-content>
          <div class="address-info">
            <ion-icon name="location-outline"></ion-icon>
            <div>
              <p><strong>Address:</strong> {{karenderia.address}}</p>
              <p><strong>City:</strong> {{karenderia.city}}</p>
              <p><strong>Province:</strong> {{karenderia.province}}</p>
            </div>
          </div>
          
          <div class="location-status">
            <ion-chip color="warning" *ngIf="!karenderia.latitude">
              <ion-icon name="warning"></ion-icon>
              <ion-label>Location Not Set</ion-label>
            </ion-chip>
            <ion-chip color="success" *ngIf="karenderia.latitude">
              <ion-icon name="checkmark"></ion-icon>
              <ion-label>Location Set</ion-label>
            </ion-chip>
          </div>
          
          <div class="card-actions">
            <ion-button 
              fill="outline" 
              (click)="setKarenderiaLocation(karenderia)">
              <ion-icon name="map" slot="start"></ion-icon>
              Set Map Location
            </ion-button>
            <ion-button 
              fill="outline" 
              color="success"
              (click)="approveKarenderia(karenderia)"
              [disabled]="!karenderia.latitude">
              <ion-icon name="checkmark" slot="start"></ion-icon>
              Approve
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Active Karenderias -->
    <div class="section">
      <h2>
        <ion-icon name="restaurant-outline"></ion-icon>
        Active Karenderias
      </h2>
      <p>Approved karenderias with locations set</p>
      
      <ion-card *ngFor="let karenderia of activeKarenderias" class="karenderia-card">
        <ion-card-header>
          <ion-card-title>{{karenderia.business_name}}</ion-card-title>
          <ion-card-subtitle>{{karenderia.owner_name}} • Active since {{karenderia.approved_at | date}}</ion-card-subtitle>
        </ion-card-header>
        
        <ion-card-content>
          <div class="location-coordinates">
            <ion-chip color="success">
              <ion-icon name="location"></ion-icon>
              <ion-label>{{karenderia.latitude | number:'1.6-6'}}, {{karenderia.longitude | number:'1.6-6'}}</ion-label>
            </ion-chip>
          </div>
          
          <div class="card-actions">
            <ion-button 
              fill="outline" 
              (click)="editKarenderiaLocation(karenderia)">
              <ion-icon name="pencil" slot="start"></ion-icon>
              Edit Location
            </ion-button>
            <ion-button 
              fill="outline" 
              color="medium"
              (click)="viewOnMap(karenderia)">
              <ion-icon name="eye" slot="start"></ion-icon>
              View on Map
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

  </div>
</ion-content>

<!-- Location Setting Modal -->
<ion-modal [isOpen]="isLocationModalOpen" (willDismiss)="closeLocationModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Set Location: {{selectedKarenderia?.business_name}}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeLocationModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content>
      <div class="modal-content">
        
        <!-- Address Information -->
        <div class="address-display">
          <h3>Business Address</h3>
          <p>{{selectedKarenderia?.address}}</p>
          <p>{{selectedKarenderia?.city}}, {{selectedKarenderia?.province}}</p>
        </div>
        
        <!-- Map Instructions -->
        <div class="map-instructions">
          <ion-icon name="information-circle-outline"></ion-icon>
          <p>Search for the address below, then drag the red marker to the exact location of this karenderia.</p>
        </div>
        
        <!-- Address Search -->
        <div class="search-section">
          <ion-item>
            <ion-input 
              [(ngModel)]="searchAddress"
              placeholder="Search for the address..."
              (keyup.enter)="searchLocation()">
            </ion-input>
            <ion-button 
              slot="end" 
              fill="clear" 
              (click)="searchLocation()">
              <ion-icon name="search"></ion-icon>
            </ion-button>
          </ion-item>
        </div>
        
        <!-- Map Container -->
        <div class="map-container" #adminMapContainer>
          <!-- Google Maps will be rendered here -->
        </div>
        
        <!-- Current Location Display -->
        <div class="coordinates-display" *ngIf="selectedLocation.lat && selectedLocation.lng">
          <ion-chip color="success">
            <ion-icon name="location"></ion-icon>
            <ion-label>
              {{selectedLocation.lat | number:'1.6-6'}}, {{selectedLocation.lng | number:'1.6-6'}}
            </ion-label>
          </ion-chip>
        </div>
        
        <!-- Action Buttons -->
        <div class="modal-actions">
          <ion-button 
            expand="block" 
            (click)="saveLocation()"
            [disabled]="!selectedLocation.lat || isSaving">
            <ion-icon name="save" slot="start"></ion-icon>
            {{isSaving ? 'Saving...' : 'Save Location'}}
          </ion-button>
        </div>
        
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
