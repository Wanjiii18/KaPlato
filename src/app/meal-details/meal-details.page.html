<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button (click)="goBack()" text="" defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ menuItem?.name || 'Meal Details' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="shareMenu()" fill="clear">
        <ion-icon name="share-outline"></ion-icon>
      </ion-button>
      <ion-button (click)="toggleFavorite()">
        <ion-icon [name]="isFavorite ? 'heart' : 'heart-outline'" 
                  [color]="isFavorite ? 'danger' : 'medium'"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div *ngIf="loading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading meal details...</p>
  </div>

  <div *ngIf="!loading && menuItem" class="meal-details-container">
    <!-- Compact Hero Section -->
    <div class="hero-section">
      <div class="hero-image-container">
        <img [src]="menuItem.image || 'assets/images/default-food.jpg'" 
             [alt]="menuItem.name"
             class="hero-image">
        <div class="hero-overlay">
          <div class="price-badge">
            ₱{{ menuItem.price }}
          </div>
          <div class="quick-stats">
            <div class="stat-item" *ngIf="nutritionData?.calories || menuItem.calories">
              <ion-icon name="flash"></ion-icon>
              <span>{{ nutritionData?.calories || menuItem.calories }}cal</span>
            </div>
            <div class="stat-item" *ngIf="menuItem.average_rating">
              <ion-icon name="star"></ion-icon>
              <span>{{ menuItem.average_rating | number:'1.1-1' }}</span>
            </div>
            <div class="stat-item" *ngIf="getSafetyLevelColor()">
              <ion-icon [name]="getSafetyLevelIcon()" [color]="getSafetyLevelColor()"></ion-icon>
              <span>{{ allergenAnalysis?.safetyLevel || 'Check' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Basic Info -->
      <div class="basic-info">
        <h1>{{ menuItem.name }}</h1>
        <p class="description">{{ menuItem.description }}</p>
        
        <!-- Karenderia Info -->
        <div class="karenderia-info" (click)="goToKarenderia()">
          <ion-icon name="storefront-outline"></ion-icon>
          <div class="karenderia-details">
            <h3>{{ menuItem.karenderia_name }}</h3>
            <p *ngIf="menuItem.karenderia_address">{{ menuItem.karenderia_address }}</p>
          </div>
          <ion-icon name="chevron-forward-outline"></ion-icon>
        </div>
      </div>
    </div>

    <!-- Quick Action Buttons -->
    <div class="quick-actions">
      <ion-button expand="block" fill="solid" color="primary" (click)="goToKarenderia()">
        <ion-icon name="location-outline" slot="start"></ion-icon>
        Visit Karenderia - ₱{{ menuItem.price }}
      </ion-button>
      
      <div class="secondary-actions">
        <ion-button fill="outline" size="small" (click)="toggleNutritionDetails()">
          <ion-icon name="nutrition-outline" slot="start"></ion-icon>
          Nutrition
        </ion-button>
        <ion-button fill="outline" size="small" (click)="viewSimilarMeals()">
          <ion-icon name="restaurant-outline" slot="start"></ion-icon>
          Similar
        </ion-button>
        <ion-button fill="outline" size="small" (click)="viewReviews()" *ngIf="menuItem && menuItem.total_reviews && menuItem.total_reviews > 0">
          <ion-icon name="chatbubbles-outline" slot="start"></ion-icon>
          Reviews ({{ menuItem.total_reviews }})
        </ion-button>
      </div>
    </div>

    <!-- Compact Info Cards -->
    <div class="info-cards-grid">
      
      <!-- Nutrition Card -->
      <div class="info-card nutrition-card" *ngIf="!loadingNutrition">
        <div class="card-header">
          <h3>
            <ion-icon name="nutrition-outline"></ion-icon>
            Nutrition
          </h3>
          <ion-button fill="clear" size="small" (click)="toggleNutritionDetails()">
            <ion-icon [name]="showNutritionDetails ? 'chevron-up' : 'chevron-down'"></ion-icon>
          </ion-button>
        </div>

        <!-- Compact nutrition grid -->
        <div class="nutrition-grid-compact">
          <div class="nutrition-item">
            <div class="nutrition-value">{{ nutritionData?.calories || menuItem.calories || 0 }}</div>
            <div class="nutrition-label">Calories</div>
          </div>
          <div class="nutrition-item" *ngIf="nutritionData?.protein || menuItem.protein">
            <div class="nutrition-value">{{ parseNutrientValueSafe(nutritionData?.protein) || menuItem.protein || 0 }}g</div>
            <div class="nutrition-label">Protein</div>
          </div>
          <div class="nutrition-item" *ngIf="nutritionData?.carbs || menuItem.carbs">
            <div class="nutrition-value">{{ parseNutrientValueSafe(nutritionData?.carbs) || menuItem.carbs || 0 }}g</div>
            <div class="nutrition-label">Carbs</div>
          </div>
          <div class="nutrition-item" *ngIf="nutritionData?.fat || menuItem.fat">
            <div class="nutrition-value">{{ parseNutrientValueSafe(nutritionData?.fat) || menuItem.fat || 0 }}g</div>
            <div class="nutrition-label">Fat</div>
          </div>
        </div>

        <!-- Detailed nutrition (collapsible) -->
        <div *ngIf="showNutritionDetails && nutritionData" class="detailed-nutrition">
          <div class="nutrition-detail-grid">
            <div class="nutrition-detail" *ngFor="let nutrient of nutritionData.nutrients?.slice(0, 6)">
              <span class="nutrient-name">{{ nutrient.name }}</span>
              <span class="nutrient-value">{{ nutrient.amount }}{{ nutrient.unit }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Allergen Safety Card -->
      <div class="info-card allergen-card" *ngIf="allergenAnalysis || (menuItem.allergens && menuItem.allergens.length > 0)">
        <div class="card-header">
          <h3>
            <ion-icon [name]="getSafetyLevelIcon()" [color]="getSafetyLevelColor()"></ion-icon>
            Allergen Safety
          </h3>
          <ion-chip [color]="getSafetyLevelColor()" size="small">
            <ion-label>{{ allergenAnalysis?.safetyLevel?.toUpperCase() || 'UNKNOWN' }}</ion-label>
          </ion-chip>
        </div>

        <!-- Compact warnings -->
        <div *ngIf="hasAllergenWarnings()" class="safety-warnings-compact">
          <div class="warnings-list">
            <ion-chip *ngFor="let warning of allergenAnalysis?.warnings" color="danger" size="small">
              <ion-icon name="warning"></ion-icon>
              <ion-label>{{ warning }}</ion-label>
            </ion-chip>
          </div>
        </div>

        <!-- General allergens (fallback) -->
        <div *ngIf="shouldShowGeneralAllergens()" class="general-allergens">
          <h4>Contains Allergens:</h4>
          <div class="tags-container">
            <ion-chip *ngFor="let allergen of menuItem.allergens" color="warning">
              <ion-icon name="alert-circle"></ion-icon>
              <ion-label>{{ allergen }}</ion-label>
            </ion-chip>
          </div>
        </div>

        <!-- Safety recommendations -->
        <div *ngIf="hasAllergenRecommendations()" class="safety-recommendations">
          <h4>Recommendations:</h4>
          <ul class="recommendations-list">
            <li *ngFor="let recommendation of allergenAnalysis?.recommendations">
              {{ recommendation }}
            </li>
          </ul>
        </div>

        <!-- No allergen info available -->
        <div *ngIf="!allergenAnalysis && (!menuItem.allergens || menuItem.allergens.length === 0)" class="no-allergen-info">
          <ion-icon name="help-circle" color="medium"></ion-icon>
          <p>No allergen information available. Please check with the restaurant if you have specific allergies.</p>
        </div>
      </div>

      <!-- Dietary Tags -->
      <div class="info-card" *ngIf="menuItem.dietary_tags && menuItem.dietary_tags.length > 0">
        <h3>Dietary Information</h3>
        <div class="tags-container">
          <ion-chip *ngFor="let tag of menuItem.dietary_tags" color="success">
            <ion-label>{{ tag }}</ion-label>
          </ion-chip>
        </div>
      </div>

      <!-- Ingredients -->
      <div class="info-card">
        <div class="card-header">
          <h3>
            <ion-icon name="restaurant-outline"></ion-icon>
            Ingredients
          </h3>
          <ion-chip color="medium" size="small" *ngIf="getIngredientsList().length > 0">
            <ion-label>{{ getIngredientsList().length }} items</ion-label>
          </ion-chip>
        </div>
        
        <!-- Ingredients List -->
        <div class="ingredients-list" *ngIf="getIngredientsList().length > 0">
          <div class="ingredients-grid">
            <ion-chip *ngFor="let ingredient of getIngredientsList()" 
                      color="light" 
                      class="ingredient-chip">
              <ion-icon name="leaf-outline" slot="start"></ion-icon>
              <ion-label>{{ ingredient }}</ion-label>
            </ion-chip>
          </div>
        </div>
        
        <!-- No Ingredients Message -->
        <div class="no-ingredients" *ngIf="getIngredientsList().length === 0">
          <ion-icon name="help-circle" color="medium"></ion-icon>
          <p>Ingredient information not available. Please ask the karenderia for details about this dish.</p>
          <ion-button fill="outline" size="small" (click)="goToKarenderia()">
            <ion-icon name="call-outline" slot="start"></ion-icon>
            Contact Karenderia
          </ion-button>
        </div>
      </div>

      <!-- Preparation Info -->
      <div class="info-card" *ngIf="menuItem.preparation_time || menuItem.spiciness_level">
        <h3>Preparation Details</h3>
        <div class="prep-details">
          <div *ngIf="menuItem.preparation_time" class="prep-item">
            <ion-icon name="time-outline"></ion-icon>
            <span>{{ formatTime(menuItem.preparation_time || 0) }}</span>
          </div>
          <div *ngIf="menuItem.spiciness_level" class="prep-item">
            <ion-icon name="flame-outline"></ion-icon>
            <span>Spiciness Level: {{ menuItem.spiciness_level }}/5</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Reviews Section -->
    <div class="reviews-section" *ngIf="menuItem.reviews && menuItem.reviews.length > 0">
      <div class="reviews-header">
        <h3>Customer Reviews</h3>
        <ion-button fill="clear" (click)="showReviewForm = true">
          <ion-icon name="add" slot="start"></ion-icon>
          Write Review
        </ion-button>
      </div>

      <!-- Review Form -->
      <div class="review-form" *ngIf="showReviewForm">
        <h4>Share Your Experience</h4>
        <div class="rating-input">
          <span>Rating:</span>
          <div class="rating-stars">
            <ion-button *ngFor="let i of [1,2,3,4,5]" 
                        fill="clear" 
                        size="small"
                        (click)="setUserRating(i)">
              <ion-icon [name]="i <= userRating ? 'star' : 'star-outline'"
                        [color]="i <= userRating ? 'warning' : 'medium'"></ion-icon>
            </ion-button>
          </div>
        </div>
        <ion-textarea [(ngModel)]="userReview" 
                      placeholder="Tell others about your experience..."
                      rows="4"></ion-textarea>
        <div class="review-actions">
          <ion-button fill="clear" (click)="showReviewForm = false">Cancel</ion-button>
          <ion-button (click)="submitReview()">Submit Review</ion-button>
        </div>
      </div>

      <!-- Reviews List -->
      <div class="reviews-list">
        <div *ngFor="let review of getVisibleReviews()" class="review-item">
          <div class="review-header">
            <div class="reviewer-info">
              <img [src]="review.user_avatar || 'assets/images/default-avatar.png'" 
                   [alt]="review.user_name"
                   class="reviewer-avatar">
              <div>
                <h4>{{ review.user_name }}</h4>
                <div class="review-stars">
                  <ion-icon *ngFor="let star of getRatingStars(review.rating)" 
                            [name]="star" 
                            class="star-icon small"></ion-icon>
                </div>
              </div>
            </div>
            <span class="review-date">{{ review.created_at | date:'MMM d, y' }}</span>
          </div>
          <p class="review-comment">{{ review.comment }}</p>
          <div class="review-actions" *ngIf="review.helpful_count">
            <ion-button fill="clear" size="small">
              <ion-icon name="thumbs-up-outline" slot="start"></ion-icon>
              Helpful ({{ review.helpful_count }})
            </ion-button>
          </div>
        </div>
      </div>

      <ion-button *ngIf="menuItem.reviews.length > 3 && !showAllReviews" 
                  fill="clear" 
                  expand="block"
                  (click)="showAllReviews = true">
        Show All Reviews
      </ion-button>
    </div>
  </div>
</ion-content>
