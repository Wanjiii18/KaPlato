<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon name="chevron-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Meal Details</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="toggleFavorite()">
        <ion-icon [name]="isFavorite ? 'heart' : 'heart-outline'" 
                  [color]="isFavorite ? 'danger' : 'medium'"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div *ngIf="loading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading meal details...</p>
  </div>

  <div *ngIf="!loading && menuItem" class="meal-details-container">
    <!-- Hero Image -->
    <div class="hero-image-container">
      <img [src]="menuItem.image || 'assets/images/default-food.jpg'" 
           [alt]="menuItem.name"
           class="hero-image">
      <div class="price-badge">
        ₱{{ menuItem.price }}
      </div>
    </div>

    <!-- Basic Info -->
    <div class="basic-info">
      <h1>{{ menuItem.name }}</h1>
      <p class="description">{{ menuItem.description }}</p>
      
      <!-- Rating and Reviews -->
      <div class="rating-container" *ngIf="menuItem.average_rating">
        <div class="stars">
          <ion-icon *ngFor="let star of getRatingStars(menuItem.average_rating)" 
                    [name]="star" 
                    class="star-icon"></ion-icon>
        </div>
        <span class="rating-text">{{ menuItem.average_rating | number:'1.1-1' }}</span>
        <span class="review-count">({{ menuItem.total_reviews }} reviews)</span>
      </div>

      <!-- Karenderia Info -->
      <div class="karenderia-info" (click)="goToKarenderia()">
        <ion-icon name="storefront-outline"></ion-icon>
        <div>
          <h3>{{ menuItem.karenderia_name }}</h3>
          <p *ngIf="menuItem.karenderia_address">{{ menuItem.karenderia_address }}</p>
        </div>
        <ion-icon name="chevron-forward-outline"></ion-icon>
      </div>
    </div>

    <!-- Nutrition & Info Cards -->
    <div class="info-cards">
      <!-- Nutrition Card -->
      <div class="info-card" *ngIf="menuItem.calories">
        <h3>Nutrition Information</h3>
        <div class="nutrition-grid">
          <div class="nutrition-item">
            <span class="label">Calories</span>
            <span class="value">{{ menuItem.calories }}</span>
          </div>
          <div class="nutrition-item" *ngIf="menuItem.protein">
            <span class="label">Protein</span>
            <span class="value">{{ menuItem.protein }}g</span>
          </div>
          <div class="nutrition-item" *ngIf="menuItem.carbs">
            <span class="label">Carbs</span>
            <span class="value">{{ menuItem.carbs }}g</span>
          </div>
          <div class="nutrition-item" *ngIf="menuItem.fat">
            <span class="label">Fat</span>
            <span class="value">{{ menuItem.fat }}g</span>
          </div>
        </div>
      </div>

      <!-- Allergens Card -->
      <div class="info-card" *ngIf="menuItem.allergens && menuItem.allergens.length > 0">
        <h3>Allergen Information</h3>
        <div class="tags-container">
          <ion-chip *ngFor="let allergen of menuItem.allergens" color="warning">
            <ion-label>{{ allergen }}</ion-label>
          </ion-chip>
        </div>
      </div>

      <!-- Dietary Tags -->
      <div class="info-card" *ngIf="menuItem.dietary_tags && menuItem.dietary_tags.length > 0">
        <h3>Dietary Information</h3>
        <div class="tags-container">
          <ion-chip *ngFor="let tag of menuItem.dietary_tags" color="success">
            <ion-label>{{ tag }}</ion-label>
          </ion-chip>
        </div>
      </div>

      <!-- Ingredients -->
      <div class="info-card" *ngIf="menuItem.ingredients && menuItem.ingredients.length > 0">
        <h3>Ingredients</h3>
        <div class="ingredients-list">
          <span *ngFor="let ingredient of menuItem.ingredients; let last = last">
            {{ ingredient }}<span *ngIf="!last">, </span>
          </span>
        </div>
      </div>

      <!-- Preparation Info -->
      <div class="info-card" *ngIf="menuItem.preparation_time || menuItem.spiciness_level">
        <h3>Preparation Details</h3>
        <div class="prep-details">
          <div *ngIf="menuItem.preparation_time" class="prep-item">
            <ion-icon name="time-outline"></ion-icon>
            <span>{{ formatTime(menuItem.preparation_time) }}</span>
          </div>
          <div *ngIf="menuItem.spiciness_level" class="prep-item">
            <ion-icon name="flame-outline"></ion-icon>
            <span>Spiciness Level: {{ menuItem.spiciness_level }}/5</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Customization Options -->
    <div class="customization-section">
      <h3>Customize Your Order</h3>
      
      <!-- Quantity Selector -->
      <div class="quantity-selector">
        <label>Quantity</label>
        <div class="quantity-controls">
          <ion-button fill="outline" size="small" (click)="decrementQuantity()">
            <ion-icon name="remove"></ion-icon>
          </ion-button>
          <span class="quantity-value">{{ quantity }}</span>
          <ion-button fill="outline" size="small" (click)="incrementQuantity()">
            <ion-icon name="add"></ion-icon>
          </ion-button>
        </div>
      </div>

      <!-- Spiciness Level -->
      <div class="spiciness-selector" *ngIf="menuItem.spiciness_level">
        <label>Spiciness Level</label>
        <ion-range min="1" max="5" [(ngModel)]="selectedSpiciness" 
                   color="danger" snaps="true">
          <ion-label slot="start">Mild</ion-label>
          <ion-label slot="end">Spicy</ion-label>
        </ion-range>
      </div>

      <!-- Special Instructions -->
      <div class="special-instructions">
        <label>Special Instructions</label>
        <ion-textarea [(ngModel)]="specialInstructions" 
                      placeholder="Any special requests or modifications..."
                      rows="3"></ion-textarea>
      </div>
    </div>

    <!-- Reviews Section -->
    <div class="reviews-section" *ngIf="menuItem.reviews && menuItem.reviews.length > 0">
      <div class="reviews-header">
        <h3>Customer Reviews</h3>
        <ion-button fill="clear" (click)="showReviewForm = true">
          <ion-icon name="add" slot="start"></ion-icon>
          Write Review
        </ion-button>
      </div>

      <!-- Review Form -->
      <div class="review-form" *ngIf="showReviewForm">
        <h4>Share Your Experience</h4>
        <div class="rating-input">
          <span>Rating:</span>
          <div class="rating-stars">
            <ion-button *ngFor="let i of [1,2,3,4,5]" 
                        fill="clear" 
                        size="small"
                        (click)="setUserRating(i)">
              <ion-icon [name]="i <= userRating ? 'star' : 'star-outline'"
                        [color]="i <= userRating ? 'warning' : 'medium'"></ion-icon>
            </ion-button>
          </div>
        </div>
        <ion-textarea [(ngModel)]="userReview" 
                      placeholder="Tell others about your experience..."
                      rows="4"></ion-textarea>
        <div class="review-actions">
          <ion-button fill="clear" (click)="showReviewForm = false">Cancel</ion-button>
          <ion-button (click)="submitReview()">Submit Review</ion-button>
        </div>
      </div>

      <!-- Reviews List -->
      <div class="reviews-list">
        <div *ngFor="let review of getVisibleReviews()" class="review-item">
          <div class="review-header">
            <div class="reviewer-info">
              <img [src]="review.user_avatar || 'assets/images/default-avatar.png'" 
                   [alt]="review.user_name"
                   class="reviewer-avatar">
              <div>
                <h4>{{ review.user_name }}</h4>
                <div class="review-stars">
                  <ion-icon *ngFor="let star of getRatingStars(review.rating)" 
                            [name]="star" 
                            class="star-icon small"></ion-icon>
                </div>
              </div>
            </div>
            <span class="review-date">{{ review.created_at | date:'MMM d, y' }}</span>
          </div>
          <p class="review-comment">{{ review.comment }}</p>
          <div class="review-actions" *ngIf="review.helpful_count">
            <ion-button fill="clear" size="small">
              <ion-icon name="thumbs-up-outline" slot="start"></ion-icon>
              Helpful ({{ review.helpful_count }})
            </ion-button>
          </div>
        </div>
      </div>

      <ion-button *ngIf="menuItem.reviews.length > 3 && !showAllReviews" 
                  fill="clear" 
                  expand="block"
                  (click)="showAllReviews = true">
        Show All Reviews ({{ menuItem.reviews.length }})
      </ion-button>
    </div>

    <!-- Add to Cart Button -->
    <div class="add-to-cart-section">
      <ion-button expand="block" 
                  size="large" 
                  (click)="addToCart()"
                  [disabled]="!menuItem.available">
        <ion-icon name="bag-add-outline" slot="start"></ion-icon>
        {{ menuItem.available ? 'Add to Cart' : 'Not Available' }}
        <span class="cart-total">₱{{ (menuItem.price * quantity) | number:'1.2-2' }}</span>
      </ion-button>
    </div>
  </div>
</ion-content>
