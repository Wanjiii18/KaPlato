<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon name="chevron-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Meal Details</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="toggleFavorite()">
        <ion-icon [name]="isFavorite ? 'heart' : 'heart-outline'" 
                  [color]="isFavorite ? 'danger' : 'medium'"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div *ngIf="loading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading meal details...</p>
  </div>

  <div *ngIf="!loading && menuItem" class="meal-details-container">
    <!-- Hero Image -->
    <div class="hero-image-container">
      <img [src]="menuItem.image || 'assets/images/default-food.jpg'" 
           [alt]="menuItem.name"
           class="hero-image">
      <div class="price-badge">
        ₱{{ menuItem.price }}
      </div>
    </div>

    <!-- Basic Info -->
    <div class="basic-info">
      <h1>{{ menuItem.name }}</h1>
      <p class="description">{{ menuItem.description }}</p>
      
      <!-- Rating and Reviews -->
      <div class="rating-container" *ngIf="menuItem.average_rating">
        <div class="stars">
          <ion-icon *ngFor="let star of getRatingStars(menuItem.average_rating)" 
                    [name]="star" 
                    class="star-icon"></ion-icon>
        </div>
        <span class="rating-text">{{ menuItem.average_rating | number:'1.1-1' }}</span>
        <span class="review-count">({{ menuItem.total_reviews }} reviews)</span>
      </div>

      <!-- Karenderia Info -->
      <div class="karenderia-info" (click)="goToKarenderia()">
        <ion-icon name="storefront-outline"></ion-icon>
        <div>
          <h3>{{ menuItem.karenderia_name }}</h3>
          <p *ngIf="menuItem.karenderia_address">{{ menuItem.karenderia_address }}</p>
        </div>
        <ion-icon name="chevron-forward-outline"></ion-icon>
      </div>
    </div>

    <!-- Nutrition & Info Cards -->
    <div class="info-cards">
      <!-- Enhanced Nutrition Card with Spoonacular Data -->
      <div class="info-card nutrition-card">
        <div class="card-header">
          <h3>
            <ion-icon name="nutrition-outline"></ion-icon>
            Nutrition Information
          </h3>
          <ion-button fill="clear" (click)="toggleNutritionDetails()" *ngIf="nutritionData">
            <ion-icon [name]="showNutritionDetails ? 'chevron-up' : 'chevron-down'"></ion-icon>
          </ion-button>
        </div>

        <!-- Loading state -->
        <div *ngIf="loadingNutrition" class="loading-nutrition">
          <ion-spinner name="crescent" color="primary"></ion-spinner>
          <p>Loading nutrition data...</p>
        </div>

        <!-- Basic nutrition info -->
        <div class="nutrition-grid" *ngIf="!loadingNutrition">
          <div class="nutrition-item highlight">
            <ion-icon name="flash" [color]="getNutritionColor('calories')"></ion-icon>
            <span class="label">Calories</span>
            <span class="value">{{ (nutritionData?.calories || menuItem.calories || 0) | number }}</span>
          </div>
          <div class="nutrition-item" *ngIf="nutritionData?.protein || menuItem.protein">
            <ion-icon name="fitness" [color]="getNutritionColor('protein')"></ion-icon>
            <span class="label">Protein</span>
            <span class="value">{{ parseNutrientValueSafe(nutritionData?.protein) || menuItem.protein || 0 }}g</span>
          </div>
          <div class="nutrition-item" *ngIf="nutritionData?.carbs || menuItem.carbs">
            <ion-icon name="leaf" [color]="getNutritionColor('carbs')"></ion-icon>
            <span class="label">Carbs</span>
            <span class="value">{{ parseNutrientValueSafe(nutritionData?.carbs) || menuItem.carbs || 0 }}g</span>
          </div>
          <div class="nutrition-item" *ngIf="nutritionData?.fat || menuItem.fat">
            <ion-icon name="water" [color]="getNutritionColor('fat')"></ion-icon>
            <span class="label">Fat</span>
            <span class="value">{{ parseNutrientValueSafe(nutritionData?.fat) || menuItem.fat || 0 }}g</span>
          </div>
        </div>

        <!-- Detailed nutrition info (collapsible) -->
        <div *ngIf="showNutritionDetails && nutritionData && !loadingNutrition" class="detailed-nutrition">
          <div class="nutrition-section">
            <h4>Detailed Breakdown</h4>
            <div class="nutrition-detail-grid">
              <div class="nutrition-detail" *ngFor="let nutrient of nutritionData.nutrients?.slice(0, 8)">
                <span class="nutrient-name">{{ nutrient.name }}</span>
                <span class="nutrient-value">{{ nutrient.amount }}{{ nutrient.unit }}</span>
                <span class="nutrient-percent" *ngIf="nutrient.percentOfDailyNeeds">
                  {{ nutrient.percentOfDailyNeeds | number:'1.0-1' }}% DV
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Powered by Spoonacular notice -->
        <div class="api-credit" *ngIf="nutritionData">
          <small>
            <ion-icon name="information-circle-outline"></ion-icon>
            Nutrition data powered by Spoonacular API
          </small>
        </div>
      </div>

      <!-- Enhanced Allergen Safety Card -->
      <div class="info-card allergen-card" *ngIf="allergenAnalysis || (menuItem.allergens && menuItem.allergens.length > 0)">
        <div class="card-header">
          <h3>
            <ion-icon [name]="getSafetyLevelIcon()" [color]="getSafetyLevelColor()"></ion-icon>
            Allergen Safety Analysis
          </h3>
          <ion-chip [color]="getSafetyLevelColor()">
            <ion-label>{{ allergenAnalysis?.safetyLevel?.toUpperCase() || 'UNKNOWN' }}</ion-label>
          </ion-chip>
        </div>

        <!-- Safety warnings -->
        <div *ngIf="hasAllergenWarnings()" class="safety-warnings">
          <h4 class="warning-title">⚠️ Allergen Warnings</h4>
          <div class="warnings-list">
            <ion-chip *ngFor="let warning of allergenAnalysis?.warnings" color="danger">
              <ion-icon name="warning"></ion-icon>
              <ion-label>{{ warning }}</ion-label>
            </ion-chip>
          </div>
        </div>

        <!-- General allergens (fallback) -->
        <div *ngIf="shouldShowGeneralAllergens()" class="general-allergens">
          <h4>Contains Allergens:</h4>
          <div class="tags-container">
            <ion-chip *ngFor="let allergen of menuItem.allergens" color="warning">
              <ion-icon name="alert-circle"></ion-icon>
              <ion-label>{{ allergen }}</ion-label>
            </ion-chip>
          </div>
        </div>

        <!-- Safety recommendations -->
        <div *ngIf="hasAllergenRecommendations()" class="safety-recommendations">
          <h4>Recommendations:</h4>
          <ul class="recommendations-list">
            <li *ngFor="let recommendation of allergenAnalysis?.recommendations">
              {{ recommendation }}
            </li>
          </ul>
        </div>

        <!-- No allergen info available -->
        <div *ngIf="!allergenAnalysis && (!menuItem.allergens || menuItem.allergens.length === 0)" class="no-allergen-info">
          <ion-icon name="help-circle" color="medium"></ion-icon>
          <p>No allergen information available. Please check with the restaurant if you have specific allergies.</p>
        </div>
      </div>

      <!-- Dietary Tags -->
      <div class="info-card" *ngIf="menuItem.dietary_tags && menuItem.dietary_tags.length > 0">
        <h3>Dietary Information</h3>
        <div class="tags-container">
          <ion-chip *ngFor="let tag of menuItem.dietary_tags" color="success">
            <ion-label>{{ tag }}</ion-label>
          </ion-chip>
        </div>
      </div>

      <!-- Ingredients -->
      <div class="info-card" *ngIf="menuItem.ingredients && menuItem.ingredients.length > 0">
        <h3>Ingredients</h3>
        <div class="ingredients-list">
          <span *ngFor="let ingredient of menuItem.ingredients; let last = last">
            {{ ingredient }}<span *ngIf="!last">, </span>
          </span>
        </div>
      </div>

      <!-- Preparation Info -->
      <div class="info-card" *ngIf="menuItem.preparation_time || menuItem.spiciness_level">
        <h3>Preparation Details</h3>
        <div class="prep-details">
          <div *ngIf="menuItem.preparation_time" class="prep-item">
            <ion-icon name="time-outline"></ion-icon>
            <span>{{ formatTime(menuItem.preparation_time) }}</span>
          </div>
          <div *ngIf="menuItem.spiciness_level" class="prep-item">
            <ion-icon name="flame-outline"></ion-icon>
            <span>Spiciness Level: {{ menuItem.spiciness_level }}/5</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Customization Options -->
    <div class="customization-section">
      <h3>Customize Your Order</h3>
      
      <!-- Quantity Selector -->
      <div class="quantity-selector">
        <label>Quantity</label>
        <div class="quantity-controls">
          <ion-button fill="outline" size="small" (click)="decrementQuantity()">
            <ion-icon name="remove"></ion-icon>
          </ion-button>
          <span class="quantity-value">{{ quantity }}</span>
          <ion-button fill="outline" size="small" (click)="incrementQuantity()">
            <ion-icon name="add"></ion-icon>
          </ion-button>
        </div>
      </div>

      <!-- Spiciness Level -->
      <div class="spiciness-selector" *ngIf="menuItem.spiciness_level">
        <label>Spiciness Level</label>
        <ion-range min="1" max="5" [(ngModel)]="selectedSpiciness" 
                   color="danger" snaps="true">
          <ion-label slot="start">Mild</ion-label>
          <ion-label slot="end">Spicy</ion-label>
        </ion-range>
      </div>

      <!-- Special Instructions -->
      <div class="special-instructions">
        <label>Special Instructions</label>
        <ion-textarea [(ngModel)]="specialInstructions" 
                      placeholder="Any special requests or modifications..."
                      rows="3"></ion-textarea>
      </div>
    </div>

    <!-- Reviews Section -->
    <div class="reviews-section" *ngIf="menuItem.reviews && menuItem.reviews.length > 0">
      <div class="reviews-header">
        <h3>Customer Reviews</h3>
        <ion-button fill="clear" (click)="showReviewForm = true">
          <ion-icon name="add" slot="start"></ion-icon>
          Write Review
        </ion-button>
      </div>

      <!-- Review Form -->
      <div class="review-form" *ngIf="showReviewForm">
        <h4>Share Your Experience</h4>
        <div class="rating-input">
          <span>Rating:</span>
          <div class="rating-stars">
            <ion-button *ngFor="let i of [1,2,3,4,5]" 
                        fill="clear" 
                        size="small"
                        (click)="setUserRating(i)">
              <ion-icon [name]="i <= userRating ? 'star' : 'star-outline'"
                        [color]="i <= userRating ? 'warning' : 'medium'"></ion-icon>
            </ion-button>
          </div>
        </div>
        <ion-textarea [(ngModel)]="userReview" 
                      placeholder="Tell others about your experience..."
                      rows="4"></ion-textarea>
        <div class="review-actions">
          <ion-button fill="clear" (click)="showReviewForm = false">Cancel</ion-button>
          <ion-button (click)="submitReview()">Submit Review</ion-button>
        </div>
      </div>

      <!-- Reviews List -->
      <div class="reviews-list">
        <div *ngFor="let review of getVisibleReviews()" class="review-item">
          <div class="review-header">
            <div class="reviewer-info">
              <img [src]="review.user_avatar || 'assets/images/default-avatar.png'" 
                   [alt]="review.user_name"
                   class="reviewer-avatar">
              <div>
                <h4>{{ review.user_name }}</h4>
                <div class="review-stars">
                  <ion-icon *ngFor="let star of getRatingStars(review.rating)" 
                            [name]="star" 
                            class="star-icon small"></ion-icon>
                </div>
              </div>
            </div>
            <span class="review-date">{{ review.created_at | date:'MMM d, y' }}</span>
          </div>
          <p class="review-comment">{{ review.comment }}</p>
          <div class="review-actions" *ngIf="review.helpful_count">
            <ion-button fill="clear" size="small">
              <ion-icon name="thumbs-up-outline" slot="start"></ion-icon>
              Helpful ({{ review.helpful_count }})
            </ion-button>
          </div>
        </div>
      </div>

      <ion-button *ngIf="menuItem.reviews.length > 3 && !showAllReviews" 
                  fill="clear" 
                  expand="block"
                  (click)="showAllReviews = true">
        Show All Reviews ({{ menuItem.reviews.length }})
      </ion-button>
    </div>

    <!-- Add to Cart Button -->
    <div class="add-to-cart-section">
      <ion-button expand="block" 
                  size="large" 
                  (click)="addToCart()"
                  [disabled]="!menuItem.available">
        <ion-icon name="bag-add-outline" slot="start"></ion-icon>
        {{ menuItem.available ? 'Add to Cart' : 'Not Available' }}
        <span class="cart-total">₱{{ (menuItem.price * quantity) | number:'1.2-2' }}</span>
      </ion-button>
    </div>
  </div>
</ion-content>
